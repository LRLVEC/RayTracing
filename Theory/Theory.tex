\documentclass[UTF8]{ctexart}
\usepackage{geometry}
\usepackage{indentfirst}
\usepackage{hyperref}
\usepackage{harpoon}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
% \usepackage{mathpazo}
\geometry{a4paper, left=1cm, right=1cm, top=2cm, bottom=2cm}
\setlength{\parindent}{1cm}
\renewcommand
\contentsname{Content}
\title{光线追踪算法理论}
\author{段元兴}
\date{\today}
\begin{document}
\maketitle
\thispagestyle{empty}
\setcounter{page}{1}
\newpage
\tableofcontents
\newpage
    \section{摘要}
        作为Computer Graphics的圣杯----光线追踪,是一个十分古老但是热门的算法.
        接下来将简要的介绍光线追踪算法的理论推导及基本实现.
    \section{基本原理}
        \indent 真实世界的几何光学模型是光线从光源发出,经过折射,镜面反射,漫反射等方式进
        入人眼.而现有计算机图形学的基本渲染方法却是光栅化,即利用空间投影变换将各种基本
        图形元素(如三角形)投影到屏幕坐标然后上色等等.然而这种做法有先天性的巨大缺陷:在
        实现折射反射及阴影等效果的时候需要利用各种所谓的技巧才能不太精确的模拟真实情况.\\
        \indent 而光线追踪算法突破了这些传统图形学的局限性.一般来说光线追踪算法分两种:\\
        \indent 1.正向光线追踪:完全按照真实世界的几何光学模型,模拟的光线从光源发出,经过
        折射反射等等作用进入人眼从而被看到.而由于一般只有少量从光源发出的光线被人眼看到,
        所以这种方法浪费了巨大的计算能力.\\
        \indent 2.反向光线追踪:利用几何光线的光路可逆性,将原来的光线的方向改变从人眼出发,
        极大的降低了所需要的光线数量.但是在路径追踪里,通常也需要与正向追踪结合来加快寻找
        光源的速度.\\
        \indent 对于反向光线追踪我们获取了光线命中的图元的自发光颜色(如果是光源)并将其与
        现有光线颜色按照当前光线所占比例混合,直到最终没有与任何图元相交(取天空盒子的背景
        颜色).而对于反射系数不为0的界面,计算出新的法向代替原法向然后重复这一过程.而对于折
        射光线,则将分出一束折射光线然后重复.由于glsl语言不支持递归,所以这里需要对栈进行模
        拟.但是由渲染方程可知物体之间是存在漫反射和焦散效果的,但是由于目前尚未采用蒙特卡
        洛随机采样来进行路径追踪(性能是原因之一),故在此忽略\dots,但是对于光源的漫反射我们
        仍然会计算.\\
    \section{理论推导}
        \subsection{基本模型的数学描述}
            由于计算机只认识数,所以我们要将当前的各种物理模型转换成数学语言.这里涉及到基本的矢
            量计算.
            \subsubsection{颜色模型}
                虽然自然生活中光的波长是连续分布的,但是在这里采用显示器的描述方式,即用$(R,G,B)$的混合来描述千千万万种个颜色.
                而一个物体的光学属性则十分复杂,这里仅仅考虑其表面的自发光颜色$g$(glow),表面的反射颜色$r$(reflect),透射
                颜色$t$(transmission),对光源的漫反射系数$d$(diffuse)和折射率$n$.所以用类$Color:\{r,t,g,d,n\}$来储存颜色信息.
                而这些信息有可能随着在几何图元上的位置的不同而变化,因此有必要建立一个纹理坐标,
                使\includegraphics[width=0.5cm]{./Opengl_Tiny.jpg}能够从纹理数组读取这些信息.
            \subsubsection{光线的基本模型}
                一根光线由出发点$\vec{p_0}$,方向$\vec{n}$(已经归一化),颜色构成.为了方便GPU优化计算,这里的
                $\vec{p_0}$加上一个$w=1$分量构成$p^\mu=(\vec{p_0},1)$.\\
                \indent 而颜色一般由$(R,G,B)$三个分量来表示.由于我们用的是反向光线追踪,
                所以还需要一个强度因子$(k_R,k_G,k_B)$来表示当前光线占总光线强度的比例.\\
                \indent 光线经过的所有点可以由:
                \begin{equation}\label{eq:r}
                    r^\mu=p_0^\mu+t\vec{n},t\geqslant 0
                \end{equation}
                来表述.
            \subsubsection{平面模型}
                这里平面的定义为一个无穷大的三维中的二维平面,由三维笛卡尔坐标方程来描述:
                \begin{equation}\label{eq:plane}
                    Ax+By+Cz+W=0.
                \end{equation}
                为简化描述,我们用
                \begin{equation}
                    n_p^\mu=(\vec{n_p},W)=(A,B,C,W)
                \end{equation}
                来描述这个平面,其中$\vec{n_p}$也是该平面的法向(保证已经归一化).
            \subsubsection{三角形模型}
                这里三角形用空间中三个点$\vec{p_0},\vec{p_1},\vec{p_2}$来定义,并且法向$\vec{n_p}$由顺序$p_0,p_1,p_2$
                按照右手螺旋法则定义为正方向.由这些顶点可以计算出$\vec{n_p}$(已归一化)和该三角形所在的平面$n_p^\mu$.
                而在三角形平面内的点可以用仿射坐标$\vec{t'}=(u',v')$来表示,并且该坐标的单位向量为$\vec{e_0}=\vec{p_0 p_1},
                \vec{e_1}=\vec{p_0 p_2}$.三角形的三个顶点又具有其在纹理图片上的纹理坐标
                \begin{equation}
                    \left\{
                        \begin{aligned}
                            \vec{t_0}=(u_0,v_0)\\
                            \vec{t_1}=(u_1,v_1)\\
                            \vec{t_2}=(u_2,v_2)
                        \end{aligned}
                    \right.
                \end{equation}
                从$(u',v')$计算实际纹理坐标$\vec{t}$可由以下公式得出:
                \begin{equation}
                    \vec{t}=u'\vec{t_1}+v'\vec{t_2}+(1-u'-v')\vec{t_0}.
                \end{equation}
            \subsubsection{球形模型}
                设球心的位矢为$\vec{p_1}$,半径为$R$.为方便GPU储存与计算,用$p_1^\mu=(\vec{p_1},R^2)$来储该球的几何特征.
                纹理坐标这么表示:定义一个球的z方向(类似于地球的极轴,从地心指向北极点为正方向),定义一个x方向,根据右手系
                建立球坐标系$(r,\theta,\phi)$.而纹理坐标$(u,v)$由$\theta$和$\phi$经过归一化得到:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            u=\frac{\phi}{2\pi}\\
                            v=1-\frac{\theta}{\pi}
                        \end{array}
                    \right..
                \end{equation}
            \subsubsection{圆盘模型}
                类似于所有平面图形,圆盘由其所在平面$p^\mu=(\vec{n},W)$,圆心坐标和圆半径$p_1^\mu=(\vec{p_1},R^2)$组成.而
                为了计算纹理坐标,我们还要破坏其轴对称性,即在圆盘平面内架一个$uv$坐标系.因此首先在平面内指定一个方向
                为$u$坐标正方向$e_0$,然后由法向$\vec{n}$计算出另一个坐标的单位向量$e_1$.设焦点相对圆心的位置为$\vec{d}$,
                则该点的纹理坐标为:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            u=\frac{\vec{d}\cdot\vec{e_0}}{2 R}+\frac{1}{2}\\
                            v=\frac{\vec{d}\cdot\vec{e_1}}{2 R}+\frac{1}{2}
                        \end{array}
                    \right..
                \end{equation}
            \subsubsection{圆柱模型}
                这里的圆柱只描述其侧面(底面和顶面都是由圆来描述).圆柱可以由一个圆柱底面圆心坐标$\vec{c}$,圆柱轴线
                方向$\vec{n}$(从底面圆心到顶面圆心为正方向),圆柱半径$R$和原址高度$l$这些参数表述.而侧面方程为:
                \begin{equation}
                    \left|\left(\vec{r}-\vec{c}\right) \times \vec{n} \right|=R,
                \end{equation}
                且满足:
                \begin{equation}
                    0 \leqslant \left(\vec{r}-\vec{c}\right) \cdot \vec{n} \leqslant l.
                \end{equation}
                至于纹理坐标,可以建立以下纹理坐标:以$\vec{c}$为坐标原点,以$\vec{n}$为z轴,再指定一个方向$\vec{e_0}$为
                x轴正方向,建立右手柱坐标系\\$(r,\theta,z)$.然后纹理坐标为:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            u=\frac{\theta}{2 \pi}\\
                            v=\frac{z}{l}
                        \end{array}
                    \right..
                \end{equation}
            \subsubsection{圆锥模型}
                啊哈哈
        \subsection{相交测试的推导}
            如果我们想要求光线与几何图元的相交点,则必须求出方程\ref{eq:r}中的$t$.
            \subsubsection{平面}
                方程\ref{eq:plane}即可以写成:
                \begin{equation}
                    r^\mu n^\mu=0,
                \end{equation}
                又因方程\ref{eq:r},故
                \begin{equation}
                    (p_0^\mu+t\vec{n})n^\mu=0.
                \end{equation}
                由此可以解出$t$:
                \begin{equation}\label{eq:plane's t}
                    t=-\frac{p_0^\mu n_p^\mu}{\vec{n} \cdot \vec{n_p}}.
                \end{equation}
            \subsubsection{三角形}
                光线若与一个三角形相交,则必先与该三角形所在的平面相交.由方程\ref{eq:plane's t}可求得
                $t$,由方程\ref{eq:r}可知位置矢量$r^\mu$.而为判断该交点是否在三角形内部,我们首先要计算
                该焦点在平面内的仿射坐标$(u,v)$.设交点$\vec{r}$到三角形顶点$p_1$的位矢为:
                \begin{equation}
                    \vec{d}=\vec{r}-\vec{p_1}=u\vec{e_1}+v\vec{e_2}.
                \end{equation}
                则:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            \vec{d}\cdot\vec{e_1} = {\left| \vec{e_1} \right|}^2u + \left(\vec{e_1}\cdot \vec{e_2}\right)v\\
                            \vec{d}\cdot\vec{e_2} = \left(\vec{e_1}\cdot \vec{e_2}\right)u + {\left| \vec{e_2} \right|}^2v
                        \end{array}
                    \right.,
                \end{equation}
                由此可以解出:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            u = \vec{k_1}\cdot\vec{d}\\
                            v = \vec{k_2}\cdot\vec{d}
                        \end{array}
                    \right.
                    ,
                \end{equation}
                其中:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            \vec{k_1}=\frac{{\left| \vec{e_2} \right|}^2\vec{e_1}-\left(\vec{e_1}\cdot\vec{e_2}\right)\vec{e_2}}{s}\\
                            \vec{k_2}=\frac{{\left| \vec{e_1} \right|}^2\vec{e_2}-\left(\vec{e_1}\cdot\vec{e_2}\right)\vec{e_1}}{s}
                        \end{array}
                    \right.,
                \end{equation}
                \begin{equation}
                    s=\left| \vec{e_1} \times \vec{e_2} \right|^2.
                \end{equation}
                而判断交点是否在三角形内则可由以下条件判断:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            u  \geqslant 0\\
                            v  \geqslant 0\\
                            u+v\leqslant 1
                        \end{array}
                    \right..
                \end{equation}
            \subsubsection{球形}
                光线若与一个球相交,则该直线到球心的距离小于$R$.而这个距离平方可以表示为
                $\left|\left(\vec{p_1}-\vec{p_0}\right)\times\vec{n}\right|^2$.令$\vec{d}=\vec{p_1}-\vec{p_0}$,
                则有:
                \begin{equation}
                    s^2=R^2-\left|\vec{d}\times\vec{n}\right|^2 \geqslant 0.
                \end{equation}
                球的方程为:
                \begin{equation}
                    \left|\vec{r}-\vec{p_1}\right|^2=R^2,
                \end{equation}
                代入方程\ref{eq:r}可得:
                \begin{equation}
                    \left|\vec{n}t-\vec{d}\right|^2=R^2,
                \end{equation}
                由此可以解出:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            t_1=\vec{n}\cdot\vec{d}+\sqrt{R^2-\left(\left|\vec{d}\right|^2-\left(\vec{n}\cdot\vec{d}\right)^2\right)}\\
                            t_2=\vec{n}\cdot\vec{d}-\sqrt{R^2-\left(\left|\vec{d}\right|^2-\left(\vec{n}\cdot\vec{d}\right)^2\right)}
                        \end{array}
                    \right..
                \end{equation}
                由于$\left|\vec{d}\times\vec{n}\right|^2=\left|\vec{d}\right|^2-\left(\vec{n}\cdot\vec{d}\right)^2$,
                故:
                \begin{equation}
                    \left\{
                        \begin{array}{l}
                            t_1=\vec{n}\cdot\vec{d}+s\\
                            t_2=\vec{n}\cdot\vec{d}-s
                        \end{array}
                    \right..
                \end{equation}
                当然只有其中一个解是最近的相交点于是最小的正解即为我们所求的$t$.
            \subsubsection{圆盘}
                同三角形,首先计算出相交位置$r^\mu$.然后判断是否在圆盘内:
                \begin{equation}
                    \vec{d}=\vec{r}-\vec{p_1},\\
                    \left| \vec{d} \right|^2<R^2.
                \end{equation}
                纹理坐标则是:
                \begin{equation}
                    \left\{
                        \begin{aligned}
                            u=\vec{d}\cdot\vec{e_1}\\
                            v=\vec{d}\cdot\vec{e_2}
                        \end{aligned}
                    \right..
                \end{equation}
        \subsection{光线传播的模拟}
            为了达到真实的光学效果,需要计算光线传播过程中的镜面反射,与光源的漫反射和折射组成.
            而且对于玻璃材质,需要考虑光学的菲涅尔公式才能真实模拟光线的透射率和反射率.设光线
            与某个几何图元相交,得到以下参数:\\
            \indent 1.几何图元的法向$\vec{n}$\\
            \indent 2.光线入射方向向$\vec{n_0}$\\
            \indent 3.光线传播的距离$t$\\
            \indent 4.几何图元的折射率$n$\\
            \indent 5.几何图元的颜色信息$c$\\
            \subsubsection{镜面反射}
                考虑法向$\vec{n}$的变化:
                \begin{equation}
                    \vec{n}^{'}=
                \end{equation}
                
            
\end{document}